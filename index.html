<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso Premium | Sistema Exclusivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase App (el n√∫cleo de Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        /* Contenedor principal de cliente */
        #client-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input[type="text"] {
            text-transform: uppercase;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .error { color: #e74c3c; }
        .success { color: #27ae60; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        
        /* Panel de administraci√≥n */
        .admin-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f7fa;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .admin-nav {
            background: #34495e;
            padding: 0.5rem 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: transparent;
            border: none;
            color: #ecf0f1;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            width: auto;
        }
        
        .nav-btn:hover, .nav-btn.active {
            background: #3498db;
        }
        
        .admin-content {
            padding: 2rem;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .card.active { border-top: 4px solid #2ecc71; }
        .card.inactive { border-top: 4px solid #e74c3c; }
        .card.devices { border-top: 4px solid #3498db; }
        .card.usage { border-top: 4px solid #f39c12; }
        
        .admin-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .code-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .code-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #2ecc71;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .code-item.inactive {
            border-left-color: #e74c3c;
        }
        
        .code-info {
            flex: 1;
            width: 100%;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .code-value {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .code-name {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }
        
        .code-contact {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }
        
        .code-stats {
            font-size: 0.85rem;
            color: #7f8c8d;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .code-actions {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            justify-content: flex-end;
        }
        
        .action-btn {
            padding: 0.4rem 0.6rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .btn-activate {
            background: #2ecc71;
            color: white;
        }
        
        .btn-deactivate {
            background: #e74c3c;
            color: white;
        }
        
        .btn-edit {
            background: #3498db;
            color: white;
        }
        
        .btn-info {
            background: #f39c12;
            color: white;
        }
        
        .device-list {
            display: grid;
            gap: 1rem;
        }
        
        .device-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-info {
            flex: 1;
        }
        
        .device-id {
            font-weight: bold;
            margin-bottom: 0.3rem;
        }
        
        .device-meta {
            font-size: 0.85rem;
            color: #7f8c8d;
        }
        
        .admin-login {
            display: none;
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .admin-link {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #2c3e50;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
        }
        
        .search-box {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .search-box input {
            flex: 1;
            margin: 0;
        }
        
        .search-box button {
            width: auto;
            margin: 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #e8f5e9;
            color: #2ecc71;
        }
        
        .status-inactive {
            background: #ffebee;
            color: #e74c3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 0.5rem;
        }
        
        .detail-label {
            font-weight: 500;
            width: 120px;
            color: #7f8c8d;
        }
        
        .detail-value {
            flex: 1;
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .code-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .admin-nav {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Interfaz principal para clientes -->
    <div id="client-container">
        <div class="container">
            <h1>üîí Acceso al Sistema</h1>
            <form id="access-form">
                <input 
                    type="text" 
                    id="code" 
                    placeholder="Ej: A1B2" 
                    required
                    maxlength="4"
                    pattern="[A-Z0-9]{4}"
                    title="4 letras/n√∫meros (may√∫sculas)"
                >
                <button type="submit">INGRESAR</button>
            </form>
            <p id="message" class="error"></p>
            <p id="device-info" class="info"></p>
            <p class="warning"><small>Horario de soporte: <strong>10:00 AM - 4:00 PM</strong></small></p>
            <p><small>¬øProblemas? Contacta a soporte: <strong>0412-527-8450</strong></small></p>
        </div>
        
        <!-- Enlace flotante para acceder al panel de administraci√≥n -->
        <a href="#" class="admin-link" id="admin-access">
            <i class="fas fa-cog"></i>
        </a>
    </div>

    <!-- Panel de login para administradores -->
    <div class="admin-login" id="admin-login">
        <h2><i class="fas fa-lock"></i> Acceso Administrador</h2>
        <form id="admin-login-form">
            <div class="form-group">
                <label for="admin-user">Usuario:</label>
                <input type="text" id="admin-user" placeholder="Usuario" required>
            </div>
            <div class="form-group">
                <label for="admin-password">Contrase√±a:</label>
                <input type="password" id="admin-password" placeholder="Contrase√±a" required>
            </div>
            <button type="submit"><i class="fas fa-sign-in-alt"></i> ACCEDER</button>
        </form>
        <p id="admin-message" class="error"></p>
    </div>

    <!-- Panel de administraci√≥n -->
    <div class="admin-panel" id="admin-panel">
        <div class="admin-header">
            <h2><i class="fas fa-shield-alt"></i> Panel de Administraci√≥n</h2>
            <button id="logout-btn" class="nav-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
        </div>
        
        <div class="admin-nav">
            <button class="nav-btn active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="nav-btn" data-tab="codes"><i class="fas fa-key"></i> C√≥digos</button>
            <button class="nav-btn" data-tab="devices"><i class="fas fa-laptop"></i> Dispositivos</button>
            <button class="nav-btn" data-tab="settings"><i class="fas fa-cog"></i> Configuraci√≥n</button>
        </div>
        
        <div class="admin-content">
            <!-- Loading indicator -->
            <div class="loading" id="admin-loading">
                <div class="loading-spinner"></div>
                <p>Cargando datos...</p>
            </div>
            
            <!-- Dashboard -->
            <div class="tab-content active" id="dashboard">
                <h2 class="section-title">Resumen del Sistema</h2>
                
                <div class="dashboard-cards">
                    <div class="card active">
                        <div class="card-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="card-title">C√≥digos Activos</div>
                        <div class="card-value" id="stat-active">0</div>
                    </div>
                    
                    <div class="card inactive">
                        <div class="card-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="card-title">C√≥digos Inactivos</div>
                        <div class="card-value" id="stat-inactive">0</div>
                    </div>
                    
                    <div class="card devices">
                        <div class="card-icon">
                            <i class="fas fa-laptop"></i>
                        </div>
                        <div class="card-title">Dispositivos Registrados</div>
                        <div class="card-value" id="stat-devices">0</div>
                    </div>
                    
                    <div class="card usage">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-title">Uso Promedio</div>
                        <div class="card-value" id="stat-usage">0%</div>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h3 class="section-title">C√≥digos Recientes</h3>
                    <div class="code-grid" id="recent-codes">
                        <!-- Los c√≥digos se cargar√°n din√°micamente -->
                    </div>
                </div>
            </div>
            
            <!-- Gesti√≥n de C√≥digos -->
            <div class="tab-content" id="codes">
                <h2 class="section-title">Gesti√≥n de C√≥digos de Acceso</h2>
                
                <div class="admin-section">
                    <div class="filters">
                        <div class="form-group">
                            <label>Estado:</label>
                            <select id="filter-status">
                                <option value="">Todos</option>
                                <option value="active">Activos</option>
                                <option value="inactive">Inactivos</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Dispositivos:</label>
                            <select id="filter-devices">
                                <option value="">Todos</option>
                                <option value="full">Llenos</option>
                                <option value="available">Con espacio</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Ordenar por:</label>
                            <select id="filter-sort">
                                <option value="recent">M√°s recientes</option>
                                <option value="oldest">M√°s antiguos</option>
                                <option value="name">Nombre</option>
                                <option value="code">C√≥digo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" id="code-search" placeholder="Buscar por c√≥digo, nombre, tel√©fono...">
                        <button id="search-btn"><i class="fas fa-search"></i></button>
                        <button id="clear-search" class="action-btn btn-deactivate"><i class="fas fa-times"></i> Limpiar</button>
                    </div>
                    
                    <div class="section-actions">
                        <button id="generate-code-btn" class="action-btn btn-activate">
                            <i class="fas fa-plus"></i> Generar Nuevo C√≥digo
                        </button>
                    </div>
                    
                    <div class="code-grid" id="all-codes">
                        <!-- Los c√≥digos se cargar√°n din√°micamente -->
                    </div>
                </div>
            </div>
            
            <!-- Gesti√≥n de Dispositivos -->
            <div class="tab-content" id="devices">
                <h2 class="section-title">Dispositivos Registrados</h2>
                
                <div class="admin-section">
                    <div class="form-group">
                        <label>Filtrar por c√≥digo:</label>
                        <select id="code-selector">
                            <option value="">Todos los dispositivos</option>
                        </select>
                    </div>
                    
                    <div class="device-list" id="devices-list">
                        <!-- Los dispositivos se cargar√°n din√°micamente -->
                    </div>
                </div>
            </div>
            
            <!-- Configuraci√≥n -->
            <div class="tab-content" id="settings">
                <h2 class="section-title">Configuraci√≥n del Sistema</h2>
                
                <div class="admin-section">
                    <h3 class="section-title">L√≠mites del Sistema</h3>
                    <div class="form-group">
                        <label>L√≠mite de dispositivos por c√≥digo:</label>
                        <input type="number" id="max-devices" value="3" min="1" max="10">
                    </div>
                    
                    <div class="form-group">
                        <label>Tiempo de inactividad (minutos):</label>
                        <input type="number" id="inactivity-timeout" value="10" min="1" max="60">
                    </div>
                    
                    <div class="form-group">
                        <label>URL de redirecci√≥n:</label>
                        <input type="text" id="redirect-url" placeholder="https://ejemplo.com">
                    </div>
                    
                    <button id="save-settings" class="action-btn btn-activate">
                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                    </button>
                </div>
                
                <div class="admin-section">
                    <h3 class="section-title">Credenciales de Administrador</h3>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="admin-username" placeholder="Usuario administrador">
                    </div>
                    
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="admin-password" placeholder="Nueva contrase√±a">
                    </div>
                    
                    <div class="form-group">
                        <label>Confirmar contrase√±a:</label>
                        <input type="password" id="admin-password-confirm" placeholder="Confirmar contrase√±a">
                    </div>
                    
                    <button id="save-admin" class="action-btn btn-activate">
                        <i class="fas fa-save"></i> Guardar Credenciales
                    </button>
                </div>
                
                <div class="admin-section">
                    <h3 class="section-title">Exportar/Importar Datos</h3>
                    
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button id="export-data" class="action-btn btn-edit">
                            <i class="fas fa-download"></i> Exportar Datos
                        </button>
                        
                        <button id="import-data" class="action-btn btn-edit">
                            <i class="fas fa-upload"></i> Importar Datos
                        </button>
                        
                        <button id="reset-data" class="action-btn btn-deactivate">
                            <i class="fas fa-trash"></i> Restablecer Datos
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles del c√≥digo -->
    <div class="modal" id="code-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Detalles del C√≥digo</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="code-detail-content">
                <!-- Los detalles se cargar√°n din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar c√≥digo -->
    <div class="modal" id="code-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="code-edit-title">Nuevo C√≥digo</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="edit-code">C√≥digo:</label>
                <input type="text" id="edit-code" maxlength="4" pattern="[A-Z0-9]{4}" required>
            </div>
            <div class="form-group">
                <label for="edit-name">Nombre del cliente:</label>
                <input type="text" id="edit-name">
            </div>
            <div class="form-group">
                <label for="edit-phone">Tel√©fono:</label>
                <input type="text" id="edit-phone">
            </div>
            <div class="form-group">
                <label for="edit-email">Email:</label>
                <input type="email" id="edit-email">
            </div>
            <div class="form-group">
                <label for="edit-notes">Notas:</label>
                <textarea id="edit-notes" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="edit-status">Estado:</label>
                <select id="edit-status">
                    <option value="active">Activo</option>
                    <option value="inactive">Inactivo</option>
                </select>
            </div>
            <button id="save-code-btn" class="action-btn btn-activate">Guardar C√≥digo</button>
        </div>
    </div>

    <script>
        // üî• Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDc8tUu6Zsx7AqZSrxe5SwpDkem3esdNxw",
            authDomain: "sistema-acceso-d6bfd.firebaseapp.com",
            projectId: "sistema-acceso-d6bfd",
            storageBucket: "sistema-acceso-d6bfd.firebasestorage.app",
            messagingSenderId: "802239933617",
            appId: "1:802239933617:web:48d4fbd6185f30cfc2c690"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // üîê Configuraci√≥n de Seguridad Avanzada
        const SECURITY_CONFIG = {
            MAX_DEVICES: 3,
            INACTIVITY_TIMEOUT: 10 * 60 * 1000, // 10 minutos
            CODE_VALIDATION_DELAY: 800, // Retraso anti-fuerza bruta
            SALT: "xQ9#pL2$kM5&vR1", // Sal para hashing
            REDIRECT_URL: "https://clientes.calculadoramagica.lat/",
            ADMIN_USER: "admin", // Cambiar en producci√≥n
            ADMIN_PASSWORD: "admin123" // Cambiar en producci√≥n
        };

        // üõ°Ô∏è Sistema de Seguridad Mejorado con Firebase
        class CodeSecuritySystem {
            constructor() {
                this.initSessionProtection();
                this.checkExistingSession();
                this.loadConfigFromStorage();
            }
            
            async loadConfigFromStorage() {
                // Cargar configuraci√≥n desde Firestore
                try {
                    const configDoc = await db.collection('config').doc('security').get();
                    if (configDoc.exists) {
                        const configData = configDoc.data();
                        if (configData.maxDevices) SECURITY_CONFIG.MAX_DEVICES = configData.maxDevices;
                        if (configData.inactivityTimeout) SECURITY_CONFIG.INACTIVITY_TIMEOUT = configData.inactivityTimeout * 60 * 1000;
                        if (configData.redirectUrl) SECURITY_CONFIG.REDIRECT_URL = configData.redirectUrl;
                        if (configData.adminUser) SECURITY_CONFIG.ADMIN_USER = configData.adminUser;
                        if (configData.adminPassword) SECURITY_CONFIG.ADMIN_PASSWORD = configData.adminPassword;
                    }
                } catch (error) {
                    console.error("Error cargando configuraci√≥n:", error);
                }
            }

            // üîÑ Generar ID de dispositivo √∫nico y persistente
            generateDeviceId() {
                const storedId = localStorage.getItem('secureDeviceId');
                if (storedId) return storedId;

                const fingerprint = [
                    navigator.userAgent,
                    navigator.hardwareConcurrency,
                    screen.width,
                    screen.height,
                    navigator.deviceMemory,
                    SECURITY_CONFIG.SALT
                ].join('|');

                const deviceId = this.hashString(fingerprint) + '-' + Date.now().toString(36);
                localStorage.setItem('secureDeviceId', deviceId);
                return deviceId;
            }

            // üî¢ Algoritmo de hashing mejorado
            hashString(str) {
                let hash = 5381;
                for (let i = 0; i < str.length; i++) {
                    hash = (hash * 33) ^ str.charCodeAt(i);
                }
                return (hash >>> 0).toString(36);
            }

            // üè∑Ô∏è Obtener dispositivos registrados para un c√≥digo
            async getRegisteredDevices(code) {
                try {
                    const codeDoc = await db.collection('codes').doc(code).get();
                    if (codeDoc.exists) {
                        return codeDoc.data().devices || [];
                    }
                    return [];
                } catch (error) {
                    console.error("Error obteniendo dispositivos:", error);
                    return [];
                }
            }

            // ‚ûï Registrar nuevo dispositivo de forma segura
            async registerDevice(code) {
                const deviceId = this.generateDeviceId();
                
                try {
                    const codeRef = db.collection('codes').doc(code);
                    const codeDoc = await codeRef.get();
                    
                    if (!codeDoc.exists) {
                        return { success: false, reason: "C√≥digo no v√°lido" };
                    }
                    
                    const codeData = codeDoc.data();
                    const devices = codeData.devices || [];
                    
                    // Verificar si ya est√° registrado
                    if (devices.some(dev => dev.id === deviceId)) {
                        return { success: true, isNew: false };
                    }

                    // Verificar l√≠mite de dispositivos
                    if (devices.length >= SECURITY_CONFIG.MAX_DEVICES) {
                        return { success: false, reason: "L√≠mite de dispositivos alcanzado" };
                    }

                    // Registrar nuevo dispositivo
                    devices.push({
                        id: deviceId,
                        timestamp: Date.now(),
                        ua: navigator.userAgent.substring(0, 120),
                        lastAccess: Date.now()
                    });

                    // Actualizar en Firebase
                    await codeRef.update({
                        devices: devices,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    return { success: true, isNew: true };
                } catch (error) {
                    console.error("Error registrando dispositivo:", error);
                    return { success: false, reason: "Error del sistema" };
                }
            }

            // ‚è≥ Protecci√≥n por inactividad
            initSessionProtection() {
                // Reiniciar timer en eventos de usuario
                const events = ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'];
                events.forEach(evt => {
                    document.addEventListener(evt, this.resetInactivityTimer.bind(this));
                });

                this.resetInactivityTimer();
            }

            resetInactivityTimer() {
                clearTimeout(this.inactivityTimer);
                this.inactivityTimer = setTimeout(() => {
                    this.handleInactiveSession();
                }, SECURITY_CONFIG.INACTIVITY_TIMEOUT);
            }

            handleInactiveSession() {
                // Guardar c√≥digo actual antes de redirigir
                const currentCode = localStorage.getItem('currentValidCode');
                sessionStorage.removeItem('activeSessionToken');
                
                if (currentCode) {
                    // Redirigir manteniendo el c√≥digo en localStorage
                    window.location.href = window.location.pathname;
                }
            }

            // üîç Verificar sesi√≥n existente
            async checkExistingSession() {
                const savedCode = localStorage.getItem('currentValidCode');
                const sessionToken = sessionStorage.getItem('activeSessionToken');
                
                if (savedCode && sessionToken) {
                    try {
                        const devices = await this.getRegisteredDevices(savedCode);
                        const deviceId = this.generateDeviceId();
                        
                        if (devices.some(dev => dev.id === deviceId)) {
                            // ‚úÖ Redirigir al NUEVO ENLACE (evitando 404)
                            setTimeout(() => {
                                window.location.href = SECURITY_CONFIG.REDIRECT_URL;
                            }, 500);
                        }
                    } catch (error) {
                        console.error("Error verificando sesi√≥n:", error);
                    }
                }
            }

            // ‚úÖ Validar c√≥digo de acceso
            async validateAccessCode(code) {
                return new Promise(async resolve => {
                    setTimeout(async () => {
                        try {
                            const codeDoc = await db.collection('codes').doc(code).get();
                            
                            if (!codeDoc.exists || !codeDoc.data().active) {
                                resolve({ valid: false, error: "C√≥digo no v√°lido" });
                                return;
                            }

                            const registration = await this.registerDevice(code);
                            if (!registration.success) {
                                resolve({ valid: false, error: registration.reason });
                                return;
                            }

                            // Establecer sesi√≥n v√°lida
                            localStorage.setItem('currentValidCode', code);
                            sessionStorage.setItem('activeSessionToken', this.hashString(Date.now().toString()));
                            
                            resolve({ valid: true, isNewDevice: registration.isNew });
                        } catch (error) {
                            console.error("Error validando c√≥digo:", error);
                            resolve({ valid: false, error: "Error del sistema" });
                        }
                    }, SECURITY_CONFIG.CODE_VALIDATION_DELAY);
                });
            }

            // ‚ÑπÔ∏è Obtener informaci√≥n de dispositivos registrados
            async getDeviceRegistrationInfo(code) {
                try {
                    const devices = await this.getRegisteredDevices(code);
                    const currentDeviceId = this.generateDeviceId();
                    
                    const isCurrentRegistered = devices.some(dev => dev.id === currentDeviceId);
                    const availableSlots = SECURITY_CONFIG.MAX_DEVICES - devices.length;
                    
                    return {
                        isRegistered: isCurrentRegistered,
                        registeredDevices: devices.length,
                        maxDevices: SECURITY_CONFIG.MAX_DEVICES,
                        availableSlots: availableSlots > 0 ? availableSlots : 0
                    };
                } catch (error) {
                    console.error("Error obteniendo informaci√≥n de dispositivo:", error);
                    return {
                        isRegistered: false,
                        registeredDevices: 0,
                        maxDevices: SECURITY_CONFIG.MAX_DEVICES,
                        availableSlots: SECURITY_CONFIG.MAX_DEVICES
                    };
                }
            }

            // üë®‚Äçüíº M√©todos para el panel de administraci√≥n
            async getAllCodes() {
                try {
                    const snapshot = await db.collection('codes').get();
                    const codes = [];
                    
                    snapshot.forEach(doc => {
                        const codeData = doc.data();
                        codes.push({
                            code: doc.id,
                            active: codeData.active || false,
                            devices: codeData.devices ? codeData.devices.length : 0,
                            created: codeData.created ? codeData.created.toDate() : new Date(),
                            lastAccess: codeData.devices && codeData.devices.length > 0 ? 
                                new Date(Math.max(...codeData.devices.map(d => d.lastAccess || d.timestamp))) : null,
                            name: codeData.name || '',
                            phone: codeData.phone || '',
                            email: codeData.email || '',
                            notes: codeData.notes || ''
                        });
                    });
                    
                    return codes;
                } catch (error) {
                    console.error("Error obteniendo c√≥digos:", error);
                    return [];
                }
            }
            
            async getClientInfo(code) {
                try {
                    const codeDoc = await db.collection('codes').doc(code).get();
                    if (codeDoc.exists) {
                        const data = codeDoc.data();
                        return {
                            name: data.name || '',
                            phone: data.phone || '',
                            email: data.email || '',
                            notes: data.notes || ''
                        };
                    }
                    return { name: '', phone: '', email: '', notes: '' };
                } catch (error) {
                    console.error("Error obteniendo informaci√≥n del cliente:", error);
                    return { name: '', phone: '', email: '', notes: '' };
                }
            }
            
            async saveClientInfo(code, info) {
                try {
                    await db.collection('codes').doc(code).set({
                        name: info.name,
                        phone: info.phone,
                        email: info.email,
                        notes: info.notes,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    return true;
                } catch (error) {
                    console.error("Error guardando informaci√≥n del cliente:", error);
                    return false;
                }
            }
            
            async setCodeStatus(code, active) {
                try {
                    await db.collection('codes').doc(code).set({
                        active: active,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    return true;
                } catch (error) {
                    console.error("Error actualizando estado del c√≥digo:", error);
                    return false;
                }
            }
            
            async removeDevice(code, deviceId) {
                try {
                    const codeRef = db.collection('codes').doc(code);
                    const codeDoc = await codeRef.get();
                    
                    if (codeDoc.exists) {
                        const codeData = codeDoc.data();
                        const devices = codeData.devices || [];
                        const filteredDevices = devices.filter(dev => dev.id !== deviceId);
                        
                        await codeRef.update({
                            devices: filteredDevices,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error("Error eliminando dispositivo:", error);
                    return false;
                }
            }
            
            async generateNewCode() {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let newCode = '';
                let attempts = 0;
                const maxAttempts = 50;
                
                do {
                    newCode = '';
                    for (let i = 0; i < 4; i++) {
                        newCode += characters.charAt(Math.floor(Math.random() * characters.length));
                    }
                    attempts++;
                    
                    if (attempts >= maxAttempts) {
                        const timestamp = Date.now().toString();
                        newCode = newCode.substring(0, 3) + timestamp.charAt(timestamp.length - 1);
                        break;
                    }
                    
                    // Verificar si el c√≥digo ya existe en Firebase
                    const codeDoc = await db.collection('codes').doc(newCode).get();
                    if (!codeDoc.exists) break;
                    
                } while (true);
                
                // Crear el nuevo c√≥digo en Firebase
                try {
                    await db.collection('codes').doc(newCode).set({
                        active: true,
                        created: firebase.firestore.FieldValue.serverTimestamp(),
                        devices: [],
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    return newCode;
                } catch (error) {
                    console.error("Error creando nuevo c√≥digo:", error);
                    return null;
                }
            }
            
            async getAllDevices() {
                try {
                    const codes = await this.getAllCodes();
                    const devices = [];
                    
                    for (const codeData of codes) {
                        if (codeData.devices > 0) {
                            const codeDevices = await this.getRegisteredDevices(codeData.code);
                            codeDevices.forEach(device => {
                                devices.push({
                                    ...device,
                                    code: codeData.code,
                                    clientName: codeData.name
                                });
                            });
                        }
                    }
                    
                    return devices;
                } catch (error) {
                    console.error("Error obteniendo dispositivos:", error);
                    return [];
                }
            }
            
            async getDevicesByCode(code) {
                try {
                    if (!code) return await this.getAllDevices();
                    
                    const codeData = await this.getClientInfo(code);
                    const clientName = codeData.name;
                    const devices = await this.getRegisteredDevices(code);
                    
                    return devices.map(device => ({
                        ...device,
                        code: code,
                        clientName: clientName
                    }));
                } catch (error) {
                    console.error("Error obteniendo dispositivos por c√≥digo:", error);
                    return [];
                }
            }
            
            async updateSettings(newSettings) {
                try {
                    await db.collection('config').doc('security').set({
                        maxDevices: newSettings.maxDevices,
                        inactivityTimeout: newSettings.inactivityTimeout,
                        redirectUrl: newSettings.redirectUrl,
                        adminUser: newSettings.adminUser,
                        adminPassword: newSettings.adminPassword,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    // Actualizar configuraci√≥n local
                    if (newSettings.maxDevices) SECURITY_CONFIG.MAX_DEVICES = newSettings.maxDevices;
                    if (newSettings.inactivityTimeout) SECURITY_CONFIG.INACTIVITY_TIMEOUT = newSettings.inactivityTimeout * 60 * 1000;
                    if (newSettings.redirectUrl) SECURITY_CONFIG.REDIRECT_URL = newSettings.redirectUrl;
                    if (newSettings.adminUser) SECURITY_CONFIG.ADMIN_USER = newSettings.adminUser;
                    if (newSettings.adminPassword) SECURITY_CONFIG.ADMIN_PASSWORD = newSettings.adminPassword;
                    
                    return true;
                } catch (error) {
                    console.error("Error actualizando configuraci√≥n:", error);
                    return false;
                }
            }
            
            async exportData() {
                try {
                    const codesSnapshot = await db.collection('codes').get();
                    const configDoc = await db.collection('config').doc('security').get();
                    
                    const data = {
                        codes: {},
                        config: configDoc.exists ? configDoc.data() : {}
                    };
                    
                    codesSnapshot.forEach(doc => {
                        data.codes[doc.id] = doc.data();
                    });
                    
                    return JSON.stringify(data);
                } catch (error) {
                    console.error("Error exportando datos:", error);
                    return null;
                }
            }
            
            async importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    
                    // Importar configuraci√≥n
                    if (data.config) {
                        await db.collection('config').doc('security').set(data.config);
                    }
                    
                    // Importar c√≥digos
                    if (data.codes) {
                        for (const code in data.codes) {
                            await db.collection('codes').doc(code).set(data.codes[code]);
                        }
                    }
                    
                    // Recargar configuraci√≥n
                    await this.loadConfigFromStorage();
                    
                    return true;
                } catch (error) {
                    console.error("Error importando datos:", error);
                    return false;
                }
            }
            
            async resetData() {
                if (confirm('¬øEST√Å SEGURO? Esta acci√≥n eliminar√° todos los datos excepto los c√≥digos. No se puede deshacer.')) {
                    try {
                        // Eliminar todos los documentos de la colecci√≥n codes
                        const codesSnapshot = await db.collection('codes').get();
                        const batch = db.batch();
                        
                        codesSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        
                        // Restablecer configuraci√≥n por defecto
                        await db.collection('config').doc('security').set({
                            maxDevices: 3,
                            inactivityTimeout: 10,
                            redirectUrl: "https://clientes.calculadoramagica.lat/",
                            adminUser: "admin",
                            adminPassword: "admin123",
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Recargar configuraci√≥n
                        await this.loadConfigFromStorage();
                        
                        return true;
                    } catch (error) {
                        console.error("Error restableciendo datos:", error);
                        return false;
                    }
                }
                return false;
            }
        }

        // üë®‚Äçüíº Sistema de Administraci√≥n
        class AdminSystem {
            constructor(securitySystem) {
                this.securitySystem = securitySystem;
                this.currentCode = null;
                this.initAdminEvents();
                this.loadSettings();
            }
            
            async loadSettings() {
                // Cargar configuraciones guardadas desde Firebase
                try {
                    const configDoc = await db.collection('config').doc('security').get();
                    if (configDoc.exists) {
                        const configData = configDoc.data();
                        if (configData.maxDevices) {
                            document.getElementById('max-devices').value = configData.maxDevices;
                        }
                        if (configData.inactivityTimeout) {
                            document.getElementById('inactivity-timeout').value = configData.inactivityTimeout;
                        }
                        if (configData.redirectUrl) {
                            document.getElementById('redirect-url').value = configData.redirectUrl;
                        }
                        if (configData.adminUser) {
                            document.getElementById('admin-username').value = configData.adminUser;
                        }
                    }
                } catch (error) {
                    console.error("Error cargando configuraci√≥n:", error);
                }
            }
            
            initAdminEvents() {
                // Enlace flotante para acceder al login de administraci√≥n
                document.getElementById('admin-access').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('client-container').style.display = 'none';
                    document.getElementById('admin-login').style.display = 'block';
                });
                
                // Login de administrador
                document.getElementById('admin-login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAdminLogin();
                });
                
                // Cerrar sesi√≥n
                document.getElementById('logout-btn').addEventListener('click', () => {
                    this.handleAdminLogout();
                });
                
                // Navegaci√≥n por pesta√±as
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.target.getAttribute('data-tab');
                        this.switchTab(tab);
                    });
                });
                
                // Generar nuevo c√≥digo
                document.getElementById('generate-code-btn').addEventListener('click', () => {
                    this.showCodeEditModal();
                });
                
                // Seleccionar c√≥digo para ver dispositivos
                document.getElementById('code-selector').addEventListener('change', (e) => {
                    this.loadDevices(e.target.value);
                });
                
                // Buscar c√≥digo
                document.getElementById('search-btn').addEventListener('click', () => {
                    this.searchCodes();
                });
                
                // Limpiar b√∫squeda
                document.getElementById('clear-search').addEventListener('click', () => {
                    document.getElementById('code-search').value = '';
                    this.loadCodes();
                });
                
                // Filtros
                document.getElementById('filter-status').addEventListener('change', () => {
                    this.applyFilters();
                });
                
                document.getElementById('filter-devices').addEventListener('change', () => {
                    this.applyFilters();
                });
                
                document.getElementById('filter-sort').addEventListener('change', () => {
                    this.applyFilters();
                });
                
                // Guardar configuraciones
                document.getElementById('save-settings').addEventListener('click', () => {
                    this.saveSettings();
                });
                
                // Guardar credenciales de administrador
                document.getElementById('save-admin').addEventListener('click', () => {
                    this.saveAdminCredentials();
                });
                
                // Exportar datos
                document.getElementById('export-data').addEventListener('click', () => {
                    this.exportData();
                });
                
                // Importar datos
                document.getElementById('import-data').addEventListener('click', () => {
                    this.importData();
                });
                
                // Restablecer datos
                document.getElementById('reset-data').addEventListener('click', () => {
                    this.resetData();
                });
                
                // Guardar c√≥digo
                document.getElementById('save-code-btn').addEventListener('click', () => {
                    this.saveCode();
                });
                
                // Cerrar modales
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.modal').forEach(modal => {
                            modal.style.display = 'none';
                        });
                    });
                });
                
                // Cerrar modal al hacer clic fuera
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });
            }
            
            async handleAdminLogin() {
                const username = document.getElementById('admin-user').value;
                const password = document.getElementById('admin-password').value;
                
                try {
                    // Verificar credenciales contra Firebase Auth o contra la configuraci√≥n
                    const configDoc = await db.collection('config').doc('security').get();
                    if (configDoc.exists) {
                        const configData = configDoc.data();
                        if (username === configData.adminUser && password === configData.adminPassword) {
                            document.getElementById('admin-login').style.display = 'none';
                            document.getElementById('admin-panel').style.display = 'block';
                            this.loadAdminData();
                        } else {
                            document.getElementById('admin-message').textContent = 'Credenciales incorrectas';
                        }
                    }
                } catch (error) {
                    console.error("Error en login:", error);
                    document.getElementById('admin-message').textContent = 'Error del sistema';
                }
            }
            
            handleAdminLogout() {
                document.getElementById('admin-panel').style.display = 'none';
                document.getElementById('client-container').style.display = 'block';
                document.getElementById('admin-user').value = '';
                document.getElementById('admin-password').value = '';
                document.getElementById('admin-message').textContent = '';
            }
            
            switchTab(tabName) {
                // Desactivar todas las pesta√±as
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Activar la pesta√±a seleccionada
                document.getElementById(tabName).classList.add('active');
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Recargar datos si es necesario
                if (tabName === 'codes') {
                    this.loadCodes();
                } else if (tabName === 'devices') {
                    this.loadCodeSelector();
                    this.loadDevices();
                } else if (tabName === 'dashboard') {
                    this.loadDashboard();
                } else if (tabName === 'settings') {
                    this.loadSettings();
                }
            }
            
            async loadAdminData() {
                await this.loadDashboard();
                await this.loadCodeSelector();
            }
            
            async loadDashboard() {
                try {
                    // Mostrar loading
                    document.getElementById('admin-loading').style.display = 'block';
                    
                    const codes = await this.securitySystem.getAllCodes();
                    const activeCodes = codes.filter(code => code.active).length;
                    const inactiveCodes = codes.filter(code => !code.active).length;
                    const totalDevices = codes.reduce((sum, code) => sum + code.devices, 0);
                    const usagePercentage = Math.round((totalDevices / (codes.length * SECURITY_CONFIG.MAX_DEVICES)) * 100);
                    
                    // Actualizar estad√≠sticas
                    document.getElementById('stat-active').textContent = activeCodes;
                    document.getElementById('stat-inactive').textContent = inactiveCodes;
                    document.getElementById('stat-devices').textContent = totalDevices;
                    document.getElementById('stat-usage').textContent = `${usagePercentage}%`;
                    
                    // Cargar c√≥digos recientes (√∫ltimos 5)
                    const recentCodes = codes
                        .sort((a, b) => b.created - a.created)
                        .slice(0, 5);
                    
                    const recentCodesContainer = document.getElementById('recent-codes');
                    recentCodesContainer.innerHTML = '';
                    
                    recentCodes.forEach(codeData => {
                        const codeElement = this.createCodeElement(codeData);
                        recentCodesContainer.appendChild(codeElement);
                    });
                    
                    // Ocultar loading
                    document.getElementById('admin-loading').style.display = 'none';
                } catch (error) {
                    console.error("Error cargando dashboard:", error);
                    document.getElementById('admin-loading').style.display = 'none';
                }
            }
            
            async loadCodes() {
                try {
                    const codes = await this.securitySystem.getAllCodes();
                    this.displayCodes(codes);
                } catch (error) {
                    console.error("Error cargando c√≥digos:", error);
                }
            }
            
            async applyFilters() {
                const statusFilter = document.getElementById('filter-status').value;
                const devicesFilter = document.getElementById('filter-devices').value;
                const sortBy = document.getElementById('filter-sort').value;
                const searchTerm = document.getElementById('code-search').value.toLowerCase();
                
                let filteredCodes = await this.securitySystem.getAllCodes();
                
                // Aplicar filtro de estado
                if (statusFilter === 'active') {
                    filteredCodes = filteredCodes.filter(code => code.active);
                } else if (statusFilter === 'inactive') {
                    filteredCodes = filteredCodes.filter(code => !code.active);
                }
                
                // Aplicar filtro de dispositivos
                if (devicesFilter === 'full') {
                    filteredCodes = filteredCodes.filter(code => code.devices >= SECURITY_CONFIG.MAX_DEVICES);
                } else if (devicesFilter === 'available') {
                    filteredCodes = filteredCodes.filter(code => code.devices < SECURITY_CONFIG.MAX_DEVICES);
                }
                
                // Aplicar b√∫squeda
                if (searchTerm) {
                    filteredCodes = filteredCodes.filter(code => 
                        code.code.toLowerCase().includes(searchTerm) ||
                        (code.name && code.name.toLowerCase().includes(searchTerm)) ||
                        (code.phone && code.phone.includes(searchTerm)) ||
                        (code.email && code.email.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Aplicar ordenamiento
                switch (sortBy) {
                    case 'recent':
                        filteredCodes.sort((a, b) => b.created - a.created);
                        break;
                    case 'oldest':
                        filteredCodes.sort((a, b) => a.created - b.created);
                        break;
                    case 'name':
                        filteredCodes.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                        break;
                    case 'code':
                        filteredCodes.sort((a, b) => a.code.localeCompare(b.code));
                        break;
                }
                
                this.displayCodes(filteredCodes);
            }
            
            displayCodes(codes) {
                const codesContainer = document.getElementById('all-codes');
                codesContainer.innerHTML = '';
                
                if (codes.length === 0) {
                    codesContainer.innerHTML = '<p>No se encontraron c√≥digos</p>';
                    return;
                }
                
                codes.forEach(codeData => {
                    const codeElement = this.createCodeElement(codeData);
                    codesContainer.appendChild(codeElement);
                });
            }
            
            createCodeElement(codeData) {
                const codeElement = document.createElement('div');
                codeElement.className = `code-item ${codeData.active ? '' : 'inactive'}`;
                
                const createdDate = new Date(codeData.created).toLocaleDateString();
                const lastAccess = codeData.lastAccess ? new Date(codeData.lastAccess).toLocaleDateString() : 'Nunca';
                
                codeElement.innerHTML = `
                    <div class="code-info">
                        <div class="code-header">
                            <div class="code-value">${codeData.code}</div>
                            <span class="status-badge ${codeData.active ? 'status-active' : 'status-inactive'}">
                                ${codeData.active ? 'Activo' : 'Inactivo'}
                            </span>
                        </div>
                        ${codeData.name ? `<div class="code-name">${codeData.name}</div>` : ''}
                        ${codeData.phone ? `<div class="code-contact">üìû ${codeData.phone}</div>` : ''}
                        ${codeData.email ? `<div class='code-contact'>‚úâÔ∏è ${codeData.email}</div>` : ''}
                        <div class="code-stats">
                            <span>${codeData.devices}/${SECURITY_CONFIG.MAX_DEVICES} dispositivos</span>
                            <span>‚Ä¢ Creado: ${createdDate}</span>
                            ${codeData.lastAccess ? `<span>‚Ä¢ √öltimo acceso: ${lastAccess}</span>` : ''}
                        </div>
                    </div>
                    <div class="code-actions">
                        <button class="action-btn btn-info" data-code="${codeData.code}">
                            <i class="fas fa-info"></i>
                        </button>
                        <button class="action-btn btn-edit" data-code="${codeData.code}">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${codeData.active ? 
                            `<button class="action-btn btn-deactivate" data-code="${codeData.code}">
                                <i class="fas fa-ban"></i>
                            </button>` : 
                            `<button class="action-btn btn-activate" data-code="${codeData.code}">
                                <i class="fas fa-check"></i>
                            </button>`
                        }
                    </div>
                `;
                
                // Agregar event listeners a los botones
                const infoBtn = codeElement.querySelector('.btn-info');
                infoBtn.addEventListener('click', () => {
                    this.showCodeDetails(codeData.code);
                });
                
                const editBtn = codeElement.querySelector('.btn-edit');
                editBtn.addEventListener('click', () => {
                    this.showCodeEditModal(codeData.code);
                });
                
                const toggleBtn = codeElement.querySelector(codeData.active ? '.btn-deactivate' : '.btn-activate');
                toggleBtn.addEventListener('click', () => {
                    this.toggleCodeStatus(codeData.code, !codeData.active);
                });
                
                return codeElement;
            }
            
            async loadCodeSelector() {
                try {
                    const codes = await this.securitySystem.getAllCodes();
                    const selector = document.getElementById('code-selector');
                    selector.innerHTML = '<option value="">Todos los dispositivos</option>';
                    
                    codes.forEach(codeData => {
                        if (codeData.active && codeData.devices > 0) {
                            const option = document.createElement('option');
                            option.value = codeData.code;
                            option.textContent = `${codeData.code} - ${codeData.name || 'Sin nombre'} (${codeData.devices} dispositivos)`;
                            selector.appendChild(option);
                        }
                    });
                } catch (error) {
                    console.error("Error cargando selector de c√≥digos:", error);
                }
            }
            
            async loadDevices(codeFilter = '') {
                try {
                    const devices = await this.securitySystem.getDevicesByCode(codeFilter);
                    const devicesContainer = document.getElementById('devices-list');
                    devicesContainer.innerHTML = '';
                    
                    if (devices.length === 0) {
                        devicesContainer.innerHTML = '<p>No se encontraron dispositivos</p>';
                        return;
                    }
                    
                    devices.forEach(device => {
                        const deviceElement = document.createElement('div');
                        deviceElement.className = 'device-item';
                        
                        const registerDate = new Date(device.timestamp).toLocaleDateString();
                        const lastAccess = device.lastAccess ? new Date(device.lastAccess).toLocaleDateString() : registerDate;
                        
                        deviceElement.innerHTML = `
                            <div class="device-info">
                                <div class="device-id">C√≥digo: ${device.code} ${device.clientName ? `- ${device.clientName}` : ''}</div>
                                <div class="device-id">ID: ${device.id}</div>
                                <div class="device-meta">
                                    Navegador: ${device.ua}
                                </div>
                                <div class="device-meta">
                                    Registrado: ${registerDate} ‚Ä¢ √öltimo acceso: ${lastAccess}
                                </div>
                            </div>
                            <div class="code-actions">
                                <button class="action-btn btn-deactivate" data-code="${device.code}" data-device="${device.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        // Agregar event listener al bot√≥n
                        const btn = deviceElement.querySelector('.action-btn');
                        btn.addEventListener('click', () => {
                            this.removeDevice(device.code, device.id);
                        });
                        
                        devicesContainer.appendChild(deviceElement);
                    });
                } catch (error) {
                    console.error("Error cargando dispositivos:", error);
                }
            }
            
            async showCodeDetails(code) {
                try {
                    const codes = await this.securitySystem.getAllCodes();
                    const codeData = codes.find(c => c.code === code);
                    
                    if (!codeData) return;
                    
                    const createdDate = new Date(codeData.created).toLocaleDateString();
                    const lastAccess = codeData.lastAccess ? new Date(codeData.lastAccess).toLocaleDateString() : 'Nunca';
                    const devices = await this.securitySystem.getRegisteredDevices(code);
                    
                    let devicesHTML = '';
                    if (devices.length > 0) {
                        devices.forEach(device => {
                            const deviceDate = new Date(device.timestamp).toLocaleDateString();
                            const lastAccess = device.lastAccess ? new Date(device.lastAccess).toLocaleDateString() : deviceDate;
                            devicesHTML += `
                                <div class="detail-row">
                                    <div class="detail-label">Dispositivo:</div>
                                    <div class="detail-value">${device.id}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Navegador:</div>
                                    <div class="detail-value">${device.ua}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">Registrado:</div>
                                    <div class="detail-value">${deviceDate}</div>
                                </div>
                                <div class="detail-row">
                                    <div class="detail-label">√öltimo acceso:</div>
                                    <div class="detail-value">${lastAccess}</div>
                                </div>
                                <hr>
                            `;
                        });
                    } else {
                        devicesHTML = '<p>No hay dispositivos registrados</p>';
                    }
                    
                    document.getElementById('code-detail-content').innerHTML = `
                        <div class="detail-section">
                            <div class="detail-row">
                                <div class="detail-label">C√≥digo:</div>
                                <div class="detail-value">${codeData.code}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Estado:</div>
                                <div class="detail-value">
                                    <span class="status-badge ${codeData.active ? 'status-active' : 'status-inactive'}">
                                        ${codeData.active ? 'Activo' : 'Inactivo'}
                                    </span>
                                </div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Dispositivos:</div>
                                <div class="detail-value">${codeData.devices}/${SECURITY_CONFIG.MAX_DEVICES}</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Creado:</div>
                                <div class="detail-value">${createdDate}</div>
                            </div>
                            <div class='detail-row'>
                                <div class='detail-label'>√öltimo acceso:</div>
                                <div class='detail-value'>${lastAccess}</div>
                            </div>
                        </div>
                        
                        ${codeData.name || codeData.phone || codeData.email || codeData.notes ? `
                        <div class="detail-section">
                            <h4>Informaci√≥n del Cliente</h4>
                            ${codeData.name ? `
                            <div class="detail-row">
                                <div class="detail-label">Nombre:</div>
                                <div class="detail-value">${codeData.name}</div>
                            </div>
                            ` : ''}
                            ${codeData.phone ? `
                            <div class="detail-row">
                                <div class="detail-label">Tel√©fono:</div>
                                <div class="detail-value">${codeData.phone}</div>
                            </div>
                            ` : ''}
                            ${codeData.email ? `
                            <div class="detail-row">
                                <div class="detail-label">Email:</div>
                                <div class="detail-value">${codeData.email}</div>
                            </div>
                            ` : ''}
                            ${codeData.notes ? `
                            <div class="detail-row">
                                <div class="detail-label">Notas:</div>
                                <div class="detail-value">${codeData.notes}</div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="detail-section">
                            <h4>Dispositivos Registrados</h4>
                            ${devicesHTML}
                        </div>
                    `;
                    
                    document.getElementById('code-detail-modal').style.display = 'flex';
                } catch (error) {
                    console.error("Error mostrando detalles del c√≥digo:", error);
                }
            }
            
            async showCodeEditModal(code = null) {
                this.currentCode = code;
                const modal = document.getElementById('code-edit-modal');
                const title = document.getElementById('code-edit-title');
                
                if (code) {
                    // Editar c√≥digo existente
                    title.textContent = 'Editar C√≥digo';
                    const codes = await this.securitySystem.getAllCodes();
                    const codeData = codes.find(c => c.code === code);
                    
                    if (codeData) {
                        document.getElementById('edit-code').value = codeData.code;
                        document.getElementById('edit-code').disabled = true;
                        document.getElementById('edit-name').value = codeData.name || '';
                        document.getElementById('edit-phone').value = codeData.phone || '';
                        document.getElementById('edit-email').value = codeData.email || '';
                        document.getElementById('edit-notes').value = codeData.notes || '';
                        document.getElementById('edit-status').value = codeData.active ? 'active' : 'inactive';
                    }
                } else {
                    // Nuevo c√≥digo
                    title.textContent = 'Nuevo C√≥digo';
                    document.getElementById('edit-code').value = '';
                    document.getElementById('edit-code').disabled = false;
                    document.getElementById('edit-name').value = '';
                    document.getElementById('edit-phone').value = '';
                    document.getElementById('edit-email').value = '';
                    document.getElementById('edit-notes').value = '';
                    document.getElementById('edit-status').value = 'active';
                }
                
                modal.style.display = 'flex';
            }
            
            async saveCode() {
                const code = document.getElementById('edit-code').value.toUpperCase();
                const name = document.getElementById('edit-name').value;
                const phone = document.getElementById('edit-phone').value;
                const email = document.getElementById('edit-email').value;
                const notes = document.getElementById('edit-notes').value;
                const status = document.getElementById('edit-status').value;
                
                if (!code || !/^[A-Z0-9]{4}$/.test(code)) {
                    alert('El c√≥digo debe tener 4 caracteres alfanum√©ricos');
                    return;
                }
                
                try {
                    // Guardar informaci√≥n del cliente
                    await this.securitySystem.saveClientInfo(code, {
                        name: name,
                        phone: phone,
                        email: email,
                        notes: notes
                    });
                    
                    // Actualizar estado del c√≥digo
                    await this.securitySystem.setCodeStatus(code, status === 'active');
                    
                    // Si es un c√≥digo nuevo, crearlo en Firebase
                    if (!this.currentCode) {
                        await db.collection('codes').doc(code).set({
                            active: status === 'active',
                            created: firebase.firestore.FieldValue.serverTimestamp(),
                            devices: [],
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                    }
                    
                    alert('C√≥digo guardado correctamente');
                    document.getElementById('code-edit-modal').style.display = 'none';
                    
                    // Recargar datos
                    await this.loadCodes();
                    await this.loadCodeSelector();
                    await this.loadDashboard();
                } catch (error) {
                    console.error("Error guardando c√≥digo:", error);
                    alert('Error al guardar el c√≥digo');
                }
            }
            
            async searchCodes() {
                await this.applyFilters();
            }
            
            async toggleCodeStatus(code, activate) {
                try {
                    const success = await this.securitySystem.setCodeStatus(code, activate);
                    
                    if (success) {
                        await this.loadDashboard();
                        await this.loadCodes();
                        await this.loadCodeSelector();
                        
                        alert(`C√≥digo ${code} ${activate ? 'activado' : 'desactivado'} correctamente`);
                    } else {
                        alert('Error al cambiar el estado del c√≥digo');
                    }
                } catch (error) {
                    console.error("Error cambiando estado del c√≥digo:", error);
                    alert('Error al cambiar el estado del c√≥digo');
                }
            }
            
            async removeDevice(code, deviceId) {
                if (confirm('¬øEst√°s seguro de que deseas eliminar este dispositivo?')) {
                    try {
                        const success = await this.securitySystem.removeDevice(code, deviceId);
                        
                        if (success) {
                            await this.loadDevices(document.getElementById('code-selector').value);
                            await this.loadDashboard();
                            await this.loadCodes();
                            await this.loadCodeSelector();
                            
                            alert('Dispositivo eliminado correctamente');
                        } else {
                            alert('Error al eliminar el dispositivo');
                        }
                    } catch (error) {
                        console.error("Error eliminando dispositivo:", error);
                    }
                }
            }
            
            async generateNewCode() {
                try {
                    const newCode = await this.securitySystem.generateNewCode();
                    
                    if (newCode) {
                        // Abrir modal de edici√≥n con el nuevo c√≥digo generado
                        this.showCodeEditModal(newCode);
                        
                        // Mostrar mensaje de confirmaci√≥n
                        setTimeout(() => {
                            alert(`¬°Nuevo c√≥digo generado: ${newCode}! Complete la informaci√≥n del cliente.`);
                        }, 300);
                    } else {
                        alert('Error al generar el nuevo c√≥digo');
                    }
                } catch (error) {
                    console.error("Error generando nuevo c√≥digo:", error);
                    alert('Error al generar el nuevo c√≥digo');
                }
            }
            
            async saveSettings() {
                const maxDevices = parseInt(document.getElementById('max-devices').value);
                const inactivityTimeout = parseInt(document.getElementById('inactivity-timeout').value);
                const redirectUrl = document.getElementById('redirect-url').value;
                
                if (!maxDevices || maxDevices < 1 || maxDevices > 10) {
                    alert('El l√≠mite de dispositivos debe ser entre 1 y 10');
                    return;
                }
                
                if (!inactivityTimeout || inactivityTimeout < 1 || inactivityTimeout > 60) {
                    alert('El tiempo de inactividad debe ser entre 1 y 60 minutos');
                    return;
                }
                
                if (!redirectUrl) {
                    alert('La URL de redirecci√≥n es requerida');
                    return;
                }
                
                try {
                    const success = await this.securitySystem.updateSettings({
                        maxDevices: maxDevices,
                        inactivityTimeout: inactivityTimeout,
                        redirectUrl: redirectUrl
                    });
                    
                    if (success) {
                        alert('Configuraci√≥n guardada correctamente');
                    } else {
                        alert('Error al guardar la configuraci√≥n');
                    }
                } catch (error) {
                    console.error("Error guardando configuraci√≥n:", error);
                    alert('Error al guardar la configuraci√≥n');
                }
            }
            
            async saveAdminCredentials() {
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;
                const passwordConfirm = document.getElementById('admin-password-confirm').value;
                
                if (!username) {
                    alert('El usuario es requerido');
                    return;
                }
                
                if (password && password !== passwordConfirm) {
                    alert('Las contrase√±as no coinciden');
                    return;
                }
                
                const settings = {
                    adminUser: username
                };
                
                if (password) {
                    settings.adminPassword = password;
                }
                
                try {
                    const success = await this.securitySystem.updateSettings(settings);
                    
                    if (success) {
                        alert('Credenciales guardadas correctamente');
                        document.getElementById('admin-password').value = '';
                        document.getElementById('admin-password-confirm').value = '';
                    } else {
                        alert('Error al guardar las credenciales');
                    }
                } catch (error) {
                    console.error("Error guardando credenciales:", error);
                    alert('Error al guardar las credenciales');
                }
            }
            
            async exportData() {
                try {
                    const data = await this.securitySystem.exportData();
                    
                    if (data) {
                        const blob = new Blob([data], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backup-sistema-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        alert('Datos exportados correctamente');
                    } else {
                        alert('Error al exportar los datos');
                    }
                } catch (error) {
                    console.error("Error exportando datos:", error);
                    alert('Error al exportar los datos');
                }
            }
            
            async importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const success = await this.securitySystem.importData(event.target.result);
                            
                            if (success) {
                                await this.loadSettings();
                                await this.loadAdminData();
                                alert('Datos importados correctamente');
                            } else {
                                alert('Error al importar los datos. Verifique el archivo.');
                            }
                        };
                        
                        reader.readAsText(file);
                    } catch (error) {
                        console.error("Error importando datos:", error);
                        alert('Error al importar los datos');
                    }
                };
                
                input.click();
            }
            
            async resetData() {
                try {
                    const success = await this.securitySystem.resetData();
                    
                    if (success) {
                        await this.loadSettings();
                        await this.loadAdminData();
                        alert('Datos restablecidos correctamente');
                    }
                } catch (error) {
                    console.error("Error restableciendo datos:", error);
                    alert('Error al restablecer los datos');
                }
            }
        }

        // üöÄ Inicializaci√≥n del Sistema
        document.addEventListener('DOMContentLoaded', () => {
            const securitySystem = new CodeSecuritySystem();
            const adminSystem = new AdminSystem(securitySystem);
            
            const accessForm = document.getElementById('access-form');
            const codeInput = document.getElementById('code');
            const messageEl = document.getElementById('message');
            const deviceInfoEl = document.getElementById('device-info');

            // Mostrar c√≥digo guardado si existe
            const savedCode = localStorage.getItem('currentValidCode');
            if (savedCode) {
                codeInput.value = savedCode;
                // Actualizar informaci√≥n del dispositivo
                securitySystem.getDeviceRegistrationInfo(savedCode).then(info => {
                    updateDeviceInfoDisplay(info);
                });
            }

            // üñäÔ∏è Manejar entrada de c√≥digo
            codeInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                if (this.value.length === 4) {
                    securitySystem.getDeviceRegistrationInfo(this.value).then(info => {
                        updateDeviceInfoDisplay(info);
                    });
                } else {
                    deviceInfoEl.textContent = '';
                }
            });

            // üìã Mostrar informaci√≥n de dispositivos
            function updateDeviceInfoDisplay(info) {
                if (!info || info.registeredDevices === 0) {
                    deviceInfoEl.textContent = '';
                    return;
                }

                if (info.isRegistered) {
                    deviceInfoEl.innerHTML = `‚úÖ Este dispositivo est√° registrado<br>
                                            <small>Dispositivos: ${info.registeredDevices}/${info.maxDevices}</small>`;
                    deviceInfoEl.className = 'success';
                } else if (info.availableSlots > 0) {
                    deviceInfoEl.innerHTML = `‚ö†Ô∏è Este c√≥digo tiene ${info.registeredDevices} de ${info.maxDevices} dispositivos<br>
                                            <small>A√∫n puedes registrar ${info.availableSlots} m√°s</small>`;
                    deviceInfoEl.className = 'warning';
                } else {
                    deviceInfoEl.innerHTML = `‚ùå L√≠mite de dispositivos alcanzado<br>
                                            <small>Este c√≥digo ya tiene ${info.maxDevices} dispositivos registrados</small>`;
                    deviceInfoEl.className = 'error';
                }
            }

            // üéØ Manejar env√≠o del formulario
            accessForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const code = codeInput.value.trim();
                
                // Validaci√≥n b√°sica
                if (code.length !== 4 || !/^[A-Z0-9]{4}$/.test(code)) {
                    showMessage("‚ùå El c√≥digo debe tener exactamente 4 caracteres alfanum√©ricos", "error");
                    return;
                }

                showMessage("üîí Verificando c√≥digo...", "info");
                
                const result = await securitySystem.validateAccessCode(code);
                
                if (result.valid) {
                    showMessage("‚úÖ Acceso concedido...", "success");
                    // ‚úÖ Redirigir al NUEVO ENLACE (evitando 404)
                    setTimeout(() => {
                        window.location.href = SECURITY_CONFIG.REDIRECT_URL;
                    }, 1500);
                } else {
                    showMessage(`‚ùå ${result.error}`, "error");
                }
            });

            // üí¨ Mostrar mensajes de estado
            function showMessage(text, type) {
                messageEl.innerHTML = text;
                messageEl.className = type;
            }
        });
    </script>
</body>
</html>
